---
title: "EPID 2187 Lecture Notes"
author: Ashley I. Naimi, PhD 
header-includes:
   - \DeclareMathOperator{\logit}{logit}
   - \DeclareMathOperator{\expit}{expit}
   - \usepackage{setspace}
   - \usepackage{booktabs}
   - \usepackage{multirow}
   - \usepackage{eqnarray,amsmath,amssymb}
output: #pdf_document
  tufte::tufte_handout: default
  #tufte::tufte_html: default
bibliography: ref_main_v4.bib
---

```{r setup, include=FALSE}
setwd("~/Dropbox/Documents/Courses/EPI2187/2017/")
library(cmprsk)
library(haven)
library(ggplot2)
```

\newpage
\noindent {\Large \bf Outline}
\vskip .25cm

\noindent \underline{Science 1}
\begin{itemize}
\item Science
\item Empiricism
\item Invariance vs Contingency
\end{itemize}

\noindent \underline{Science 2}
\begin{itemize}
\item Experimentation for Epidemiologic Methods
\item Monte Carlo Simulation
\item What is Collapsibility?
\item Can Poisson regression estimate risk ratios \& 95\% CIs?
\end{itemize}

\noindent \underline{Logic}
\begin{itemize}
\item Reasoning/Rationalism
\item Valid Forms
\begin{itemize}
\item Modus Ponens
\item Modus Tollens
\end{itemize}
\item Formal Fallacies
\begin{itemize}
\item Affirming the Consequent
\end{itemize}
\item Informal Fallacies
\begin{itemize}
\item Equivocation
\end{itemize}
\end{itemize}
<!-- Denying the Antecedent -->
<!-- Prosecutor's Fallacy -->

\noindent \underline{Causal Inference}
\begin{itemize}
\item Introduction
\item Complex Longitudinal Data
\item Notation
\item Estimand, Estimator, Estimate
\item Identifiability
\begin{itemize}
    \item[a.] Counterfactual Consistency
    \item[b.] No Interference
    \item[c.] Excheangability
    \item[d.] Correct Model Specification
    \item[e.] Positivity
\end{itemize}

\end{itemize}
\noindent \underline{The Parametric G-Formula}
\begin{itemize}
\item Example 0: Model-Based Standardization with Time Fixed Data
\item Example 1: Model-Based Standardization with Time-Varying Data (g formula)
\item Example 2: National Survey of Family Growth Mediation analysis 
\end{itemize}

\newpage
\onehalfspacing

\noindent {\Large \bf \underline{Science 1}}

\noindent {\Large \bf Introduction}

What is science? There are several ways to answer this question. It's a body of knowledge and a way of asking/answering questions. It's also a highly esteemed institution in modern society. There is a widely held belief that there is something special about science. If someone says that an argument, line of reasoning, or piece of evidence is "scientific," they are implying that it possesses some merit or special kind of reliability [@Chalmers1999]. But what, exactly, is it that confers this merit or reliability?

As you may know, the word "science" comes from the Latin word \emph{scientia}, which means knowledge, knowing, or expertness.^[Search for "science" at http://www.etymonline.com] Less well known is its relationship to the word \emph{scire} or \emph{scindere}, which means to cut, split, or divide (i.e., truth from falsehood). But what makes science different from other forms of knowing, or separating truth from falsehood?

The principle often used to demarcate science from non-science is what is known as \emph{empirical testability}. A statement is said to be "scientific" if it can be tested by observation or experiment [@Gordon1991]. Some authors go so far as to rule out mere observation, and require experimentation as a marker for science.

One epidemiologic example of this is a piece of the debate on natural effects [@Naimi2014c].^[The other piece is that while these effects are intersting mathematical objects, they do not really align with more practical public health objectives.] These effects require that we assume independence between two variables that can only exist in two distinct counterfactual worlds. In other words, they can never be observed together. As a result, there can never be a randomized trial conducted that will enable us to verify whether the natural effects estimated were valid or not.^[This issue has largely been superseded by new "interventional analogues"  to these natural effects. See, e.g., @VanderWeele2014 for further details.] That is, it is not \emph{empirically testable}.

The word empirical comes from the Greek word for "experience." The basic idea behind empirical testability is that observation and/or experimentation are seen as \emph{passive} extensions of the senses (which experience the world). "Passive" is used in the sense that they are not influenced by social, political, or economic forces, superstitious ideologies, or prior conceptions of reality.^[You've surely heard the phrase, "let the data speak."] Science, so it is asserted, is built on "facts," and facts are indisuptible because they are clearly laid out before us to experience first-hand. Facts [@Chalmers1999]:
\begin{itemize}
\item[] Are directly given to unprejudiced observers via the senses
\item[] Are prior to and independent of theory
\item[] Consitute a firm foundation for scientific knowledge
\end{itemize}

This characterization can be summed up as follows: Science is the generation of knowledge through observation and experimentation that generates facts about reality which leads to theories about the world. 

**But there are several problems with this characterization**. Generating "knowledge" through observation and experimentation is in no way straightforward. Experimentation and obaservation are in no way passive. There is a large and fast growing body of literature on how scientific findings are "tainted" by the prior conceptions of those doing the work [@Krieger2011,@Krieger1994,@Biagioli1994]. Data never speak. As we will see, they are interpreted in the context of culture that prevails at a given time. Finally, scientific "facts" are not always universal. Sometimes, and particularly in the health sciences, they depend entirely on social context.

We will see evidence of these assertions in our applied examples. Specifically, we'll look at some implications of not considering the particular lens we might use to investigate reality. We’ll see how an overreliance on presumed facts obtained through observation led to perverse conclusions about the nature of reality.

\noindent {\Large \bf Example: Hoffman 1896}

For centuries, scientists have observed poorer health outcomes among black people compared to white people in the U.S. Many explanations have been offered for why this is the case.

For example, in his 1896 book “Race Traits and Tendencies of the American Negro” Frederick Hoffman presents an exhaustive study of the overall health and well-being of black people in the U.S. Based on a meticulous analysis of data from several states and various countries, Hoffman concludes (p 312) that^[Note that Frederick Hoffman was not uncredentialled as a statistician. He was the president of the ASA in 1911.] 
\begin{quote}
The pages of this work give but one answer, ... In the plain language of the facts brought together the colored race is shown to be on the downward grade … Neither religion nor education nor a higher degree of economic well-being have been able to raise the race from a low and anti-social condition. … It is not in the conditions of life, but in race and heredity that we find the explanation …
\end{quote}

He averred "deaths … are largely the result of inferior organisms and constitutional weakness … one of the most pronounced race characteristics of the American negro." (p 66). Hoffman was so convinced of these "facts," that he predicted the eventual extinction of African Americans. 

What was the evidence that motivated such staggering statements? He did several analyses, and the results of the most salient are displayed in the following table:

\begin{table}
\caption{Death Rates of the White and Colored Population Under 5 Years for Two Cities According to Altitude—1886-1890. Excludes stillbirth deaths. Reproduced from Hoffman 1896, p50.}
\begin{tabular}{rllll}
\toprule
Average Altitude & \multicolumn{2}{c}{Washington} & \multicolumn{2}{c}{Baltimore} \\
(in feet) & White & Color & White & Color \\ 
\midrule
Under 25 & 78.85 & 167.69 & 86.92 & 203.30 \\
25-50 & 71.41 & 155.21 & 76.96 & 194.03 \\
50-75 & 57.59 & 159.57 & 66.16 & 148.39 \\
75-100 & 52.30 & 157.89 & 66.16 & 148.39 \\
Over 100 & 57.87 & 136.11 & 58.70 & 145.53 \\
\bottomrule
\end{tabular}
\end{table}

These analyses adjusted for altitude and population density. Others adjusted for age. His book also includes several additional tables that show similar results. Based on these results, he asks "Is it not self evident that it is the working of the law of physiological heredity rather than the effects of environment [i.e., population density and altitude] that we have here to deal with?" (p85).

Sixty years later (July 2nd 1964) president Lyndon Johnson singed into law the Civil Rights Act, which, among other things, prohibited discrimination and segregation in any institution receiving federal funds, including hospitals across the country. Thus, for the first time ever, in places like Mississippi African American mothers were able to deliver their babies in, and bring their sick children to, the same hospitals as white women. And look at what happened:

```{r, out.width = "300px",fig.cap="Number of Post-Neonatal Infant Deaths due to Diarrhea and Pneumonia by Race in Mississippi, 1955-1975 ",echo=F}
knitr::include_graphics("RaceFigure.pdf")
```

This figure shows the infant mortality rate for black and white individuals in Mississippi between 1955 and 1975 [@Almond2006]. The vertical line represents the point at which the civil rights act took effect. Rarely do we see such a dramatic change in an outcome like infant mortality resulting from a national policy.

Clearly, Hoffman mis-interpreted the meaning of the so-called "facts" laid out before him. He observed different infant mortality rates among blacks and whites under different environmental circumstances, and construed this to be a scientific fact (the data spoke). But (perhaps because of his prior beliefs/expectations/biases about the importance of race and the "nature" of black Americans?), he failed to consider that even within the same environment, the quality and access to health care for black women and their children was very different from the quality and access to health care for white women.

There are very many things to say about the analyses, data, background assumptions, and Hoffman's interpretation. Let's restrain ourselves to one fundamental issue: nature versus nurture. The entirety of Hoffman's book rests on the premise that one can analytically separate nature from nurture, heredity from context, genes from environment.^[Hoffman is not alone in doing this, as you may well know. Even today, countless studies are conducted to "separate" genetic from environmental effects. And there is an enourmous body of work on why framing analyses in these terms is problematic. For example: [@Fox-Keller2010]] 

Is this premise valid? Perhaps for simple traits, but certainly not infant/child mortality, or the many complex health outcomes studied in epidemiology. Richard Lewontin summarized the issue nicely in a classic article [@Lewontin1974] that was re-printed in the International Journal of Epidemiology. In it, he provides a compelling metaphor that illustrates the issue:
\begin{quote}
... if two men lay bricks to build a wall, we may quite fairly measure their contribution by counting the number laid by each; but if one mixes the mortar and the other lays the bricks, it would be absurd to measure their relative quantitative contributions by measuring the volumes of bricks and of mortar.
\end{quote}

If genes are the bricks and environment is the mortar, can we separate their contribution to a health outcome? 

This issue has a direct bearing on the last question we will raise in this section: whether epidemiology is a "hard" physical science, or a "soft" reflexive sociological science [@Krieger2011]? In the former view, human health and disease is seen as arising from invariant natural laws that can be examined with reference to a commonly shared (stable) physical / biological universe. In this "epidemiology as physics" view, exposure effects are construed of as fixed physical constants (parameters) that do not depend on the context in which they arise. For example, "race" is a real (material) construct grounded in genes, and not created by human beings. These genes have effects that are exerted irrespective of human context. That is, thought they may be \emph{modified} by context, the effects are still their own independent physical entities. 

In the latter view, human health and disease depends on social, political, and historical contingency, and thus requires examination with reference to these contexts. The effects of "race" are the result of the long arc of history that has yielded contemporary features of the social, political, and economic systems that characterize people's lives, rather than innate biological characteristics. In this framework, effects can be construed as biological expressions of long-standing race relations that are themselves the product of human desicion-making. In that regards, epidemiology is reflexive because health outcomes are simultaneously produced by and studied by humans.

<!-- [maybe sth on how methodology should protect, but doesn't guarantee [@Greenland2017]] -->

\newpage

\noindent {\Large \bf \underline{Science 2}}

\noindent {\Large \bf Introduction}

Now to the more practical. A critical aspect/component of a scientific mindset is testing statement about the world. In methodology, statements are made all the time, about, for example, measurement error (non-differential biases towards the null), odds ratios (is a non-collapsible measure of association), and so forth. It is often difficult to understand the situations in which these issues need careful consderation. One critically important tool in developing a solid understanding of epidemiologic methods is the "Monte Carlo" method. 

The Monte Carlo method, or Monte Carlo simulation, was introduced in the early 20th century [@Metropolis1949]. The basic idea behind this method is to use chance to solve problems that would either be intractable, or just too difficult to solve analytically. Becuase of it's use of chance, it is named after the famed Monte Carlo casino in Las Vegas, NV.

To give a simple example of the Monte Carlo method at work,^[You'll find this example on Wikipedia: https://en.wikipedia.org/wiki/Monte_Carlo_method] suppose you didn't know, but had to estimate $\pi = 3.1415926 \ldots$ Suppose further that all you knew was the following:
$$ A_S = L \times W $$
and 
$$ A_{{C}/{4}} = \frac{\pi \times r^2}{4}  $$
If you chose $L = W = r = 1$, you could take the ratio of the area of the quarter circle to the area of the unit square to give: 
$$ \pi = 4 \times \frac{A_{C/{4}}}{A_{S}} $$

You could then randomly spread points over the entire unit square. Taking four times the proportion of points that fall in the quarter circle relative to the unit square will give you an estmate of $\pi$, as in the following diagram:
```{r, out.width = "200px",fig.cap="Demonstration of how the Monte Carlo method can be used to solve for pi. Figure by nicoguaro (Own work) [CC BY 3.0 (http://creativecommons.org/licenses/by/3.0)], via Wikimedia Commons",echo=F}
knitr::include_graphics("ekoxv-kahg9.pdf")
```

\newpage
In the sections that follow, we will explore how to use the Monte Carlo method to investigate features of epidemiologic methods. The first example will look at the impact of non-collapsiblility of the odds ratio [@Greenland1999,@Greenland2005b,@Pang2013]. The second example will look at how well Poisson regression estimates the risk ratio for a binary outcome, and how to best quantify standard errors and CIs [@Zou2004].

\noindent {\Large \bf Example 1: Non-Collapsibility of the OR}

The odds ratio is a non-collapsible measure of association, and for this reason its use in epidemiology is somewhat controversial [@Pang2013a,Kaufman2010a]. Non-collapsibility is a mathematical property of the odds ratio that results from Jensen's inequality (the average of a non-linear function does not
equal the function its average; see @Greenland2011), and has confused many a statistician and epidemiologist [@Greenland1999,@Hernan2011].

In simple terms, non-collapsibility of the OR will be apparent when estimating an adjusted exposure-outcome using a conditional and marginal approach (using standard logistic regression for the conditinal approach, and IP-weighting or marginal standardization for the marginal approach). For example, in Figure 3, 
```{r, out.width = "200px",fig.cap="Simple confounding triangle, with exposure $A$, confounder $C$, and outcome $Y$.",echo=F}
knitr::include_graphics("F3.pdf")
```
we can adjust for the confounding effects of $C$ conditionally using standard regression model:
$$ \logit P(Y = 1 \mid A, C) = \beta_0 + \beta_1 A + \beta_2 C, $$
and interpreting $\beta_1$ as the conditionally adjusted effect. Or, we can output predicted probabilities from this model for each person in the sample under two conditions: $A = 1$ and $A = 0$. We can then average these two probabilities over the sample, and compare the odds for the $A = 1$ to the odds for the $A = 0$^[This method, known as marginal standardization, will be discussed thoroughly in the introductory g formula section.]

Non-collapsibility is less of an issue under the rare disease assumption (with $\lessapprox 10$\% defined as "rare"). But how valid is this $\lessapprox 10$\% cutoff? We can answer this using Monte Carlo simulation. To do this, let's simulate data following the causal relation in Figure 3.

First, we'll need to set up some funcitons and conditions. The "expit" funciton is the inverse logit function, and we'll need this to simulate from a logistic model:

```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  expit<-function(a){1/(1+exp(-a))}
```
Next we'll need a seed for reproducibility.
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  set.seed(123)
```
We can then set the sample size we want, and simulate the confounder from a standard normal distribution.
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  n=500
  # simulate confounder from a normal distribution
  ## first argument is sample size
  ## second argument is mean
  ## third argument is SD
  C<-rnorm(n,0,1)
```
With this confounder, we can simulate the exposure from a propensity model:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  # propensity model
  ## theta is a 2-dimensional vector (list) of parameters for the exposure model
  ## theta[1] is the intercept and theta[2] is the log-OR for the confounder-exposure relation
  ## pi is the probability that the exposure is 1
  theta<- c(0,log(2))
  pi <- expit(theta[1]+theta[1]*C)
  
  # simulate exposure from binomial distribution
  ## second argument is number of trials
  ## third argument is probability that A = 1
  A<-rbinom(n,1,pi)
```
And the outcome from an outcome model:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  # outcome model
  ## beta is a 3-dimensional vector (list) of parameters for the outcome model
  ## beta[1] is the intercept, beta[2] is the exp(OR) for the exposure-outcome relation
  ## beta[3] is the log-OR for the confounder-outcome relation
  beta<-c(-2.75,log(2),log(2))
  mu<-expit(beta[1] + beta[2]*A + beta[3]*C)
  Y<-rbinom(n,1,mu)
```
Our result of interest from this simualtion study will be how collapsibility is affected by the prevalence of the outcome, and whether a $\lessapprox 10$\% outcome prevalence is sufficient to render the conditional and marginal OR approximately equal. The prevalence of $Y$ can be changed by varying the intercept parameter in the outcome model above (beta[1]). To answer our question, we will need to store the prevalence of $Y$ in a variable:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  # glm.res0 is the outcome's prevalence
  ## we store this to ouput it from the function
  glm.res0<-mean(Y)
  print(glm.res0)
```
So our outcome prevalence is `r glm.res0*100`\%. Our dataset consists of three variables, and the first and last three entries are:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
head(data.frame(Y,A,C=round(C,2)),3);tail(data.frame(Y,A,C=round(C,2)),3)
```
We can now estimate the conditionally and marginally adjusted odds ratios in this sample of 500 observations. Using a condtionally adjusted model:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  # estimate the true exposure odds ratio using a conditonally adjusted logit model
  ## NB: conditionally adjusted logit model is not the same as "conditional logistic regression"
  ## glm.res1 is the conditional log-odds ratio
  m1<-glm(Y~A+C,family=binomial(link="logit"))
  glm.res1<-m1$coefficients[2]
```
Using a marginally adjusted approach:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
# estimate the true exposure odds ratio using a marginally adjusted logit model
  ## compute the average predicted probabilities under A = 1 and then A = 0
  muhat1<-mean(predict(m1,newdata=data.frame(A=1,C),type="response"))
  muhat0<-mean(predict(m1,newdata=data.frame(A=0,C),type="response"))
  
  ## compute the odds from these average probabilities
  odds1<-muhat1/(1-muhat1)
  odds0<-muhat0/(1-muhat0)
  
  ## glm.res2 is the marginal log-odds ratio
  glm.res2<-log(odds1/odds0)
```

Summarizing our results, we found that for an outcome prevalence of  `r glm.res0*100`\%, the conditionally adjusted OR was `r round(exp(glm.res1),2)`, and the marginally adjusted OR was `r round(exp(glm.res2),2)`. Not a huge difference. Keep in mind, this simulation study is extremely limited. We only used a single sample of 500 observations. Thus, the pattern in these results can be explained entirely by random noise. In typical simulation studies, one would repeat the above process 1,000, 5,000 or even 10,000 times, and take the averages of each result. 

More generally, simulation results are always limited to the particulars of the studies design [@Maldonado1997]. We simulated a scenario with one continuous standard normal confounder, a single binary exposure, well-behaved logistic models for the exposure and the outcome. Thus, we cannot state with confidence that these results apply to a situation with multiple confounders of different forms (binary, categorical, continuous), complex interaction patterns between these confounders, etc. 

\noindent {\Large \bf Example 2: Estimating risk ratios using Poisson regression}

One way to avoid issues with non-collapsibility is to estimate the risk ratio (using, e.g., log-binomial regression). The risk ratio is a collapsible measure of association [@Greenland2005], which means that it's conditionally and marginally adjusted versions will be the same, irrespective of the outcome prevalence. But, in many situations log-binomial models fail to converge [@Chu2010,@Knol2012,@Williamson2013]. One solution to this problem is to use log-Poisson regression models [@Zou2004], and it works quite well. While it will estimate the risk ratio without any problems, one cannot simply use model-based standard errors to construct confidence intervals. Instead, the robust (a.k.a. sandwich) variance estimator should be used. 

In this second example, we will ask and answer the following questions:
\begin{itemize}
\item[1)] Is Poisson regression a biased estimator of the risk ratio for a binary outcome?
\item[2)] How well does the model-based standard error from a Poisson model perform?
\item[3)] How well does the robust standard error from a Poisson model perform?
\end{itemize}

These questions require a little background knowledge of statistics. First, bias is defined as the average value of the estimator minus the true value: $E (\hat{\psi} - \psi)$. To quantify bias, we have to know the true value ($\psi$), and we have to have a sufficient number of estimates to take an average. In the context of a Monte Carlo simulation, we call a single sample of, say, 500 observations one Monte Carlo sample. As noted, we usually estimate our quantities using bewteen 1,000 and 10,000 Monte Carlo samples. 

Next, to define the "performance" of an estimator for the standard error, it's imperative to note that the standard error from a single sample is supposed to quantify the standard deviation of the estimates if the study were repeated many times. Therefore, the standard deviation of the estimates $SD(\hat{\psi})$ should be equal to the average of the standard errors from each Monte Carlo sample $E(\hat{\psi}_{SE})$. We will quantify these in the following simulation.

Two final measures of performance for the standard error estimator are confidence interval coverage, and confidence interval length. A 95\% confidence interval should include the true value 95/100 times. In each Monte Carlo sample, we can check to see if the (e.g., Wald) confidence interval includes the true value, and compute this proportion over all Monte Carlo samples. Similarly, it's easy for any confidence interval to include the true value 100\% of the time if it's wide enough. Thus, another measure of performance is the mean length between the upper and lower confidence interval limit. These will be left to quantify in a homework assignment.

Again, we'll need to set up some funcitons and conditions. We'll need the expit function, and becuase we're going to evaluate the robust variance estimator, let's install and load a library that will enable us to do that easily:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  expit<-function(a){1/(1+exp(-a))}
  # install.packages("sandwich",repos='http://lib.stat.cmu.edu/R/CRAN/')
  library(sandwich)
```
We'll again set the seed for reproducibility, specify the sample size we want, and simulate the confounder, this time from a binomial distribution with $p=0.5$.
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  set.seed(123)
  n=500
  # simulate binary confounder from a binomial distribution
  ## first argument is sample size
  ## second argument is number of trials
  ## third argument probability that C = 1
  C<-rbinom(n,1,.5)
```
With this confounder, we can now simulate the same exposure from a propensity model:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  # propensity model
  ## theta is a 2-dimensional vector (list) of parameters for the exposure model
  ## theta[1] is the intercept and theta[2] is the log-OR for the confounder-exposure relation
  ## pi is the probability that the exposure is 1
  theta<- c(0,log(2))
  pi <- expit(theta[1]+theta[1]*C)
  
  # simulate exposure from binomial distribution
  ## second argument is number of trials
  ## third argument is probability that A = 1
  A<-rbinom(n,1,pi)
```
But this time, we'll simulate the outcome from a log-binomial model, instead of a logistic. Note that the true risk ratio based on this model is 2.0:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  # simulate outcome from outcome model
  ## beta is a 3-dimensional vector (list) of parameters for the outcome model
  ## beta[1] is the intercept, beta[2] is the exp(OR) for the exposure-outcome relation
  ## beta[3] is the exp(OR) for the confounder-outcome relation
  beta<-c(-2.5,log(2),log(2))
  mu<-exp(beta[1] + beta[2]*A + beta[3]*C) ## note this is generated from a log-linear, not logistic!
  Y<-rbinom(n,1,mu)
```
Our data looks the same as what we saw in the previous example, except the confounder is binary and distribution of the outcome is different. Let's now estimate the risk ratio using log-binomial regression:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
# estimate the true exposure risk ratio using a correct log-binomial model
  ## glm.res1 is the conditional log-risk ratio
  ## glm.res1se is the standard error for the conditional log-risk ratio
  m1<-glm(Y~A+C,family=binomial(link="log"))
  glm.res1<-m1$coefficients[2]
  glm.res1se<-summary(m1)$coefficients[2,2]
```
and log-Poisson regression:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  # estimate the true exposure risk ratio using a log-poisson model
  ## glm.res2 is the conditional log-risk ratio
  ## glm.res2se_1 is the standard error for the conditional log-risk ratio
  ## glm.res2se_2 is the robust (sandwich) standard error for the conditional log-risk ratio
  m2<-glm(Y~A+C,family=poisson(link="log"))
  glm.res2<-m2$coefficients[2]
  glm.res2se_1<-summary(m2)$coefficients[2,2]
  glm.res2se_2<-sqrt(sandwich(m2)[2,2])
```
Note that for the Poisson model, we have two standard error estimates: the model based (glm.res2se_1) and the sandwich variance estimate (glm.res2se_2).^[In \texttt{R}, the "sandwich" function returns a square symmetric matrix, with the variances on the diagonal. Becuase we want the SE, we take the square root of the variance for the parameter of interest, in this case the coefficient for $A$] To compute the quantities we need to run this code at least 1,000 times, so we'll create a function wrapped around this code (not shown) that we can call using the following line:
```{r, echo=F}
# this function will simulate the data, run the models we, and output the results
# index is a counter for the number of times we will generate and estimate
simReg<-function(index){ # open the function loop
  # the "expit" function is the inverse logit
  expit<-function(a){1/(1+exp(-a))}
  # need a seed for reproducibility
  # choosing index as seed sets the seed to be
  # the simulation counter
  set.seed(index)
  # sample size
  n=500
  # simulate binary confounder from a binomial distribution
  ## first argument is sample size
  ## second argument is number of trials
  ## third argument probability that C = 1
  C<-rbinom(n,1,.5)
  # propensity model
  ## theta is a 2-dimensional vector (list) of parameters for the exposure model
  ## theta[1] is the intercept and theta[2] is the exp(OR) for the confounder-exposure relation
  theta<- c(0,log(2))
  pi <- expit(theta[1]+theta[1]*C)
  # simulate exposure from binomial distribution
  ## second argument is number of trials
  ## third argument is probability that X = 1
  A<-rbinom(n,1,pi)
  # simulate outcome from outcome model
  ## beta is a 3-dimensional vector (list) of parameters for the outcome model
  ## beta[1] is the intercept, beta[2] is the exp(OR) for the exposure-outcome relation
  ## beta[3] is the exp(OR) for the confounder-outcome relation
  beta<-c(-2.5,log(2),log(2))
  mu<-exp(beta[1] + beta[2]*A + beta[3]*C) ## note this is generated from a log-linear, and not logistic !!
  Y<-rbinom(n,1,mu)
  # estimate the true exposure risk ratio using a correct log-binomial model
  ## glm.res1 is the conditional log-risk ratio
  ## glm.res1se is the standard error for the conditional log-risk ratio
  m1<-glm(Y~A+C,family=binomial(link="log"))
  glm.res1<-m1$coefficients[2]
  glm.res1se<-summary(m1)$coefficients[2,2]
  # estimate the true exposure risk ratio using a log-poisson model
  ## glm.res2 is the conditional log-risk ratio
  ## glm.res2se_1 is the standard error for the conditional log-risk ratio
  ## glm.res2se_2 is the robust (sandwich) standard error for the conditional log-risk ratio
  m2<-glm(Y~A+C,family=poisson(link="log"))
  glm.res2<-m2$coefficients[2]
  glm.res2se_1<-summary(m2)$coefficients[2,2]
  glm.res2se_2<-sqrt(sandwich(m2)[2,2])
  ## store all results for the "index" run in a variable called "res"  
  res<-c(glm.res1,glm.res2,glm.res1se,glm.res2se_1,glm.res2se_2)
  ## this tells you which simulation is running
  #print(index)
  ## need this to output results from the function
  return(res)
} # close the function loop
```
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  res<-simReg(1)
```
To run this function 1,000 times we can put it in a for loop or use lapply.^[There are countless tutorials on and descriptions of lapply, for example: http://adv-r.had.co.nz/Functionals.html] After using lapply, we have to do some data management (e.g., "do.call"):
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
  res<-lapply(1:1000,function(x) simReg(x))
  # data management
  res<-data.frame(do.call(rbind,res))

  # there are five simulation results (res) 
  ## binomial log risk ratio
  ## Poisson log risk ratio
  ## binomial log risk ratio SE
  ## Poisson log risk ratio model-based SE
  ## Poisson log risk ratio robust SE
  names(res)<-c("RR","poisson_RR","seRR","se_poisson_RR","seR_poisson_RR")
  head(round(res,2),3)
```
Using these data, we can compute our quantities of interest. Bias is the average of all the log-RRs minus $log(2)$. For the binomial regression estimator, we get:  `r round(mean(res$RR - log(2)),2)`; for the Poisson estimator, we get: `r round(mean(res$poisson_RR - log(2)),2)`. So both are equally unbiased. 

Next, lets look at how the standard deviation of the log-RRs compares to the average standard errors. For the log binomial model we have: standard deviation = `r round(sd(res$RR),3)`, mean standard error = `r round(mean(res$seRR),3)`. For the log Poisson model we have: standard deviation = `r round(sd(res$poisson_RR),3)`, mean model-based standard error = `r round(mean(res$se_poisson_RR),3)`, mean robust standard error = `r round(mean(res$seR_poisson_RR),3)`.

Confidence interval coverage and length will be left to the assignment.

\newpage 
\noindent {\Large \bf \underline{Logic}} 

What is logic? It central to science, yet it’s importance is hardly ever emphasized (and sometimes it’s not even taught) in several scientific disciplines. Bertrand Russell once said: 

\begin{quote}
'If p then q; now q is true, therefore p is true.' E.g., 'If pigs have wings, then some winged animals are good to eat; now some winged animals are good to eat; therefore pigs have wings.' This form of inference is called the 'scientific method.' [@Russell1945]
\end{quote}

There is a reason he refers to this as 'the scientific method,' and a close study of logic will reveal why. Logic is the study of valid forms of reasoning. Loosely speaking, reasoning is your mind's process of "moving" from idea to idea to reach a conclusion. For example, you might experience something in the world (e.g., seeing the odds ratio from an analysis you just conducted) which would elicit a thought, which would elicit another, and so forth, until you might conclude: "this exposure has a strong effect on the outcome." Reasoning is usually divided into three kinds: Deductive, inductive, and abductive reasoning. 

\noindent {\Large \bf Deduction}

Deductive reasoning is often informally defined as proceeding from general laws to particular instances [e.g., @Goodman1999]. But this is not consistent with its formal definition, as deduction \emph{need} not proceed from generals to particulars [for an example, see @Greenland1998]. In a deductive argument, the conclusion is already contained in the premise; the argument only transforms the information contained in its premise. This feature of deduction is both a strength and weakness: on the one hand a valid deductive argument guarantees the truth of the conclusion if the premises are true; On the other hand, one has to know that the premises are true for the conclusion to be true. 

A deduction is a form of argument in which conclusions are derived from premises following explicit rules. If the rules that are followed are valid, then the argument is logically sound. Othwerwise, the argument is a logical fallacy. Deductive logic thus provides us with a valid way to proceed from a set of givens to a conclusion.

There are two key valid forms of deductive reasoning (these forms are also referred to as syllogisms): the modus ponens (or implication elimination) and the modus tollens (or denying the consequent). The modus ponens proceeds as:
\begin{equation*}
 P \rightarrow Q; P \therefore Q
\end{equation*}
In the above syllogism, the right arrow is read as "implies," and $\therefore$ means "therefore." So the syllogism reads: $P$ implies $Q$ (premise 1), $P$ (premise 2), therefore $Q$ (conclusion). The **modus ponens** is a fundamental form of argument in deductive logic. As an example, consider the following logic, which serves as the basis for prescription. Consider that excessive smooth muscle contractility is one key factor that leads to preterm labor:
\begin{itemize}
\item Premise 1: If calcium channel blockers (CCB) relax smooth muscle, then administering CCBs should reduce preterm labor.
\item Premise 2: CCBs relax smooth muscle.
\item Conclusion: Administering calcium channel blockers reduces the onset of preterm labor. 
\end{itemize}
In this case, the conclusion is true for two reasons: 1) the form of the argument (modus ponens) is valid; and 2) both premises are true. Consider this alternative example [@Greenland2011a]:
\begin{itemize}
\item Premise 1: If smoking causes lung cancer, then all smokers get lung cancer
\item Premise 2: Smoking causes lung cancer
\item Conclusion: All smokers get lung cancer.
\end{itemize}
This conclusion is obviously false becuase the first premise is false. However, the logical form of the argument (modus ponens) is valid. This is an important feature. One could put any nonsense as premises, and as long as the syllogism follows the above modus ponens form it would be a nonsensical, but logically valid argument. In other words, deductive validity does not depend in any way on the truth or validity of the premises. Nor does it depend on the content of the premises. It depends only on the form of the argument (i.e., the form of the relation between the premises and the conclusion).  

The second valid form of deductive reasoning is the **modus tollens**:
\begin{equation*}
 P \rightarrow Q; \neg Q \therefore \neg P
\end{equation*}
This is a second fundamental logical form. This form has a relation to a very famous case [as detailed in @Greenland2011a]. In 1959, RA Fisher reasoned that [@Fisher1959]: 
\begin{itemize}
\item Premise 1: If cigarette smoke is carcinogenic, then smokers who report inhaling would exhibit higher lung cancer rates than smokers who do not inhale.
\item Premise 2: Inhalers do not exhibit higher lung cancer rates. 
\item Conclusion: Cigarette smoking is not carcinogenic.
\end{itemize}
Premise 2 is supported by empirical evidence [@Wald1985], and premise 1 was widely held as true at the time: hence, Fisher argued (using valid logic) that smoking did not cause lung cancer. The problem is that premise 1 is not true: as it turns out, the deposition of carcinogens in key parts of the respiratory system may be just as bad in non-inhalers compared to inhalers [@Wald1985].

Fisher's deduction is valid, but is an example of the limits of logic in empirical science. In fact, the example illustrates the limitations of formal methodology (whether mathematical, logical, empirical, etc) in general. A conclusion's validity depends not just on the validity of the formal method used. It also depends profoundly on the validity of the assumptions involved. **Valid methods (modus tollens, modus pollens) can give invalid results if their premises are invalid** [@Greenland2011a].

\noindent {\Large \bf Formal Fallacies}

Valid deductive methods guarantee the truth of the conclusions if the premises are true. Logical fallacies, in contrast, occur when the manner by which one proceeds from premises to conclusions does not guarantee the truth of the conclusions when the premises are true. Such fallacies pervade science, as well as reasoning in the media and popular culture. Consider the following:
\begin{itemize}
\item Premise 1: If preeclampsia causes stillbirth, then the odds ratio for this relation will be $>1$ (or the p-value will be $<0.05$).
\item Premise 2: The estimated association is strong and positive.
\item Conclusion: Preeclampsia causes stillbirth.
\end{itemize}
In this syllogism, even though the conclusion is likely true [@Harmon2015], the procedure that takes us from the premise to the conclusion is not valid. This formal fallacy is known as **affirming the consequent**. To see why this is problematic, consider the following:
\begin{itemize}
\item Premise 1: If storks deliver babies, then the odds ratio for the relation between the stork population and the birth rate will be $>1$ (or the p-value will be $<0.05$).
\item Premise 2: The estimated $p = 0.008$.
\item Conclusion: Storks deliver babies.
\end{itemize}
Believe it or not, the second premise is actually supported by data. @Matthews2000 used data on the birth rate and the density of the white stork population (\emph{Ciconia ciconia}) in 17 European countries. Using the $t$-test, he found a test statistic of 3.06, with 15 degrees of freedom, yielding $p = 0.008$. So do storks deliver babies? No. This apparant anomoly is the result the violation of a key assumption required to use $p$-values. In fact, this assumption is central to interpreting any inferential statistic as reflective of some "causal" link between the exposure and the outcome [@Greenland1990]. That is randomization. In the study by @Matthews2000, the stork population was not randomized, and confounded by the geographic size of the country: larger countries have both more storks and higher live-birth rate. 

This feature reflects why affirming the consequent is a fallacy: the second premise could have resulted from the causal link between storks and the birth rate, or confounding, selection, information bias. Abstractly, affirming the consequent proceeds as follows:
The modus ponens proceeds as:
\begin{equation*}
 P \rightarrow Q; Q \therefore P
\end{equation*}
This mode of reasoning is incorrect becuase $Q$ could have resulted from something other than $P$.

<!-- DENYING THE ANTECEDENT -->

<!-- \noindent {\Large \bf Induction} 
Induction is often defined as the process of deriving general principles from specific observations. -->

\newpage

\noindent {\Large \bf Informal Fallacies}







\newpage
\noindent {\Large \bf \underline{Causal Inference}}

\noindent {\Large \bf Introduction}

"Causal inference" deals primarily with the formal mechanisms by which we can combine data, assumptions, and models to interpret a correlation (or association) as a causal relation.^[There are a number of excellent introductory books and articles on causal inference in the empirical sciences. Here are some excellent options: @Hernan2015, @Pearl2016, @Imbens2015] The framework by which we define what we mean by "causal relation" or "causal effect" is the **potential outcomes framework**.

A central notion in the potential outcomes framework is the counterfactual. This notion stems from the intuitive and informal practice of interpreting cause-effect relations as **circumstances (e.g., health outcomes) that would have arisen had things (e.g., exposures) been different**.

While this intuition serves an important purpose, it is not sufficient for doing rigorous science. Suppose we ask: "what is the effect of smoking on CVD risk, irrespective of smoking's effect on body weight?" This question seems clear and intiutive. To answer this question, we would do a study in which we collect data, enter these into a computer, perform some calculations, and obtain a number (the "effect").

But there is a problem.^[This problem was articulated by @Robins1987, and I am using the example from his paper.] The calculations performed by the computer are **rigorously defined mathematical objects**. On the other hand, **english language sentences about cause effect relations are ambiguous**. For example, the "effect of smoking" can mean many different things:

\begin{itemize}
\item All people smoke any tobacco ever versus no people smoke tobacco ever.
\item All people smoke 3 cigarettes per day versus all people smoke 2 cigarettes per day.
\item All people who have smoked any tobacco in the last 15 years cease to smoke any tobacco whatsoever.
\end{itemize}
\noindent Similarly, "irrespective of" can mean a number of things:
\begin{itemize}
\item The effect of smoking on CVD risk that would be observed in a hypothetical world where smoking did not affect body mass?
\item The effect of smoking on CVD risk if everyone were set to "normal" body mass?
\item The effect of smoking on CVD risk if everyone were held at the body mass they had in the month prior to study entry?
\end{itemize}

But the numerical strings of data and the computer algorithms applied to these data are well defined mathematical objects, which do not admit such ambiguity. Depending on several choices, including the data, how variables are coded, and the modeling strategy, the computer is being told which question to answer. There is a lot of potential uncertainty in the space between the English language sentences we use to ask causal questions, and the computer algorithms we use to answer those questions. Causal inference is about clarifying this uncertainty.

\noindent {\Large \bf Complex Longitudinal Data}

This short course is about complex longitudinal data, so let's define that here. We will be dealing with data from a cohort study, individuals sampled from a well-defined target population, and clear study start and stop times (i.e., closed cohort). Data from such a cohort are **longitudinal** when they are measured repeatedly over time.^[Another such form is when data are measured repeatedly across space. We will not be dealing with these data here.]

Different scenarios can lead to longitudinal data:
\begin{itemize}
\item[1.] exposure and covariates do not vary over time, but the study outcome can occur more than once
\item[2.] exposure and covariates vary over time, but the study outcome can only occur once
\item[3.] exposure and covariates vary over time, and the study outcome can occur more than once
\end{itemize}
We will deal with data that from scenario 2 (however, it is not difficult to generalize the logic to scenario 3). 
Repeated exposure, covariate, and/or outcome measurement is what leads to "longitudinal" data. But why complex? 

Repeated measurement over time opens up the possibility of complex causal relations between past and future covariates. Suppose we measure an expsoure twice over follow-up, a covariate once, and the outcome at the end of follow-up (Figure 1). If we can assume that past exposure/covariate values do not affect future exposure/covariate values (usually a very risky assumption), we might not consider these data "complex," becuase we can use many standard methods we already know to analyze these data.
```{r, out.width = "200px",fig.cap="Longitudinal data that might not be considered `complex' because there is no feedback between exposure and covariates.",echo=F}
knitr::include_graphics("F1.pdf")
```
On the other hand, if past exposure/covariates affect future exposure/covariates in such a way that prior exposures or covariates confound future exposures (Figure 2), more advanced analytic techniques are needed. 
```{r, out.width = "200px",fig.cap="The simplest kind of complex longitudinal data. Note that the exposure at time zero affects the covariate at time 1 which affects the exposure at time 1. This feedback leads to confounding of the time 1 expsoure by a covariate that is affected by the prior exposure. Analysis of these data require more general methods to  account for this complex form of confounding.",echo=F}
knitr::include_graphics("F2.pdf")
```
In this short course, we will learn how to use the parametric g formula to account for this type of complex time-varying confounding.

\noindent {\Large \bf Notation}

The building blocks for causal inference are **potential outcomes** [@Rubin2005]. These are conceptually distinct from **observed outcomes**. Potential outcomes are functions of exposures. For a given exposure $x$, we will write the potential outcome as $Y^x$.^[Alternate notation includes: $Y_x$, $Y(x)$, $Y\mid Set(X=x)$, and $Y|do(X=x)$.] **This is interpreted as "the outcome ($Y$) that would be observed if $X$ were set to some value $x$"**. For example, if $X$ is binary [denoted $X \in (0,1)$], then $Y^x$ is the outcome that would be observed if $X=0$ or $X=1$. If we wanted to be specific about the value of $x$, we could write $Y^{x=0}$ or $Y^{x=1}$ (or, more succinctly,  $Y^{0}$ or $Y^{1}$).

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 1:} Suppose you collect data from a single person and find that they are exposed. Can you interpret their outcome to be the potential outcome that would have been observed had they been exposed? Why or why not?
\end{quotation}

______________________________________________________________________________________________


When the exposoure and/or outcome are measured repeatedly over follow-up, notation must account for that. We thus use subscripts to denote when the variable was measured. For example, if the exposure is measured twice, we can denote the first measurement $X_0$ and the second $X_1$. Additionally, we use overbars to denote the history of a variable over follow-up time. For example, $\overline{X}_1$ denotes the set $\{X_0,X_1\}$. More generally, for some arbitrary point over follow-up $m$, $\overline{X}_m$ denotes $\{X_0,X_1,X_2, \ldots X_m\}$. We can then define potential outcomes as a function of these exposure histories: For two exposure measurements, $\overline{X}_j = \{1,1\}$, $Y^{\overline{x}_j = \overline{1}}$ is the outcome that would be observed if $X_0$ were set to $1$ and $X_1$ were set to $1$.

\noindent {\Large \bf Estimand, Estimator, Estimate}

Causal inference starts with a clear idea of the effect of interest (the target causal parameter). To do this, it helps to distinguish between estimands, estimators, and estimates.

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 2a:} You are familar with the well known odds ratio equation for a $2\times 2$ table: ($ab/cd$). Is this an estimand, estimator, or estimate?
\end{quotation}

______________________________________________________________________________________________


The **estimand** is the (mathematical) object we want to quantify. It is, for example, the causal risk difference, risk ratio, or odds ratio for our exposure and outcome of interest. In our smoking CVD example, we might be interested in:

$$ P( Y^{1} = 1) - P( Y^{0} =1 ),\;\;\;\frac{P( Y^{1} = 1)}{P( Y^{0} =1 )},\;\;\; \frac{Odds( Y^{1} = 1)}{ Odds( Y^{0} = 1)}, $$
where $Odds(Y^x = 1) = P(Y^x = 1)/(Y^x = 0)$. There are many others besides these.

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 2b:} List some estimators that can be used to quantify the odds ratio.
\end{quotation}

______________________________________________________________________________________________

The estimand is the object we want to estimate. The **estimator** is an equation that allows us to use our data to quantify the estimand. Suppose, for example, we were explicitly intersted in quantifying the causal risk difference for the relation between smoking and CVD risk. To do this, we have to start by quantifying the associational risk difference, but there are many ways to do this, including ordinary least squares, maximum likelihood, or the method of moments.

To be specific, let's simulate some hypothetical data on the relation between smoking and CVD. Let's look at ordinary least squares and maximum likelihood as estimators:
```{r, echo=T,fig.star=T,tidy=F,highlight=T}
### CODE SET 1
# define the expit function
expit<-function(z){1/(1+exp(-(z)))}
set.seed(123)
n<-1e6
confounder<-rbinom(n,1,.5)
smoking<-rbinom(n,1,expit(-2+log(2)*confounder))
CVD<-rbinom(n,1,.1+.05*smoking+.05*confounder)

round(mean(confounder),3)
round(mean(smoking),3)
round(mean(CVD),3)

#OLS
round(coef(lm(CVD~smoking+confounder)),4)

#ML1
round(coef(glm(CVD~smoking+confounder,family=poisson("identity"))),4)

#ML2
round(coef(glm(CVD~smoking+confounder,family=binomial("identity"))),4)
### END CODE SET 1
```
```{r, echo=F}
## for calculations below
set.seed(123)
n<-1e6;confounder<-rbinom(n,1,.5)
smoking<-rbinom(n,1,expit(-2+log(2)*confounder))
CVD<-rbinom(n,1,.1+.05*smoking+.05*confounder)
pC<-round(mean(confounder),3)
ols_RD<-round(coef(lm(CVD~smoking+confounder)),4)
```
In our simple setting with 1 million observations, ordinary least squares and maximum likelihood yielded the same associational risk difference (as expected) even though they are different **estimators**. Finally, the values obtained from each regression approach are our **estimates**.

\noindent {\Large \bf Identifiability}

In our simulation example, we estimated the associational risk difference using three different estimators. Estimating associations is all we can do with empirical data. But we want to use the associational risk difference to quantify the causal risk difference. We can only do so if the causal risk difference is **identified**. A parameter (e.g., causal risk difference) is identified if we can write it as a function of the observed data.

The causal risk difference is defined as a contrast of potential outcomes. Referring back to our simulated example, we want to estimate the causal risk difference conditional on $C$:
$$ P( Y^{1} = 1 \mid C) - P( Y^{0} =1 \mid C ), $$
where $Y^1$, $Y^0$ are the potential CVD outcomes that would be observed if smoking were set to 1 and 0, respectively. On the other hand, the associational risk difference is defined as a contrast of observed outcomes:
$$ P( Y = 1 \mid X = 1, C) - P( Y = 1 \mid X = 0, C), $$
where each term in this equation is interpreted as the risk of CVD **among those who had $X=x$**. The causal risk difference is identified if the following equation holds:^[Throughout this course, we will assume that the target parameter of interest is a causal contrast of potential outcomes. Sometimes, the target parameter of interest is an associational contrast, and the assumptions needed are less demanding. See, e.g., @Naimi2016c.]
$$ P(Y^x = 1 \mid C) = P(Y = 1 \mid X = x, C) $$
which says that the risk of CVD that would be observed if everyone were set to $X=x$ is equal to the risk of CVD that we observe among those with $X=x$. In this equation, the right hand side equation is written entirely in terms of observed data ($Y=1$). The left hand side is a function of unobserved potential outcomes ($Y^x=1$). This equivalence will only hold if we can make some assumptions.

The first is **counterfactual consistency**, which states that the potential outcome that would be observed if we set the exposure to the observed value is the observed outcome [@Hernan2005b,@Hernan2008a,@Hernan2011a,@VanderWeele2013b].^[While somewhat convoluted, this assumption is about legitimizing the connection between our observational study, and future interventions in actual populations. In our observational study, we **see** people with with a certain value of the exposure. In a future intervention, we **set** people to a certain value of the exposure.] Formally, counterfactually consistency states that:
$$\text{ if }X = x\text{ then }Y^x = Y $$
The status of this assumption remains unaffected by the choice of analytic method (e.g., standard regression versus g methods). Rather, this assumption’s validity depends on the nature of the exposure assignment mechanism.

We must also assume **no interference**, which states that the potential outcome for any given individual does not depend on the exposure status of another individual [@Hudgens2008,@Naimi2015]. If this assumption were not true, we would have to write the potential outcomes as a function of the expsoure status of multiple individuals. For example, for two different people indexed by $i$ and $j$, we might write: $Y_i^{x_i,x_j}$.^[Together, counterfactual consistency and no interference make up the stable-unit treatment value assumption (SUTVA), first articulated by @Rubin1980.] Notation and methods that account for interference can be somewhat complex [@Tchetgen2012,@Halloran2016], and we will not consider the impact of interference here.

Together, counterfactual consistency and no interference allow us to make some progress in writing the potential risk $P(Y^x = 1 \mid C)$ as a function of the observed risk $P(Y = 1 \mid X=x, C)$. Specifically, by counterfactual consistency and no interference, we can do the following:
$$ P( Y = 1 \mid X = x, C) = P(Y^x = 1 \mid X = x, C) $$
A third assumption is **exchangeability**, which implies that the potential outcomes under a specific exposure ($Y^x$) are independent of the observed exposures $X$ [@Greenland1986,@Greenland1999,@Greenland2009]. If this holds, then we have: 
$$ P(Y^x = 1 \mid X=x, C) = P(Y^x = 1 \mid C) $$
If there is any confounding, selection, or information bias, the potential outcome will be associated with the observed exposure, and we cannot remove $X=x$ from the conditioning statement.^[For an excellent discussion of why the potential outcomes are independent of the observed exposure under exchangeability, see Chapter 2 of @Hernan2015] What this means is that the exposure is predictive of prognosis, independent of it's actual effect on the outcome. 

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 3:} Why is the word "exchangeable" used to describe this concept? What, precisely, is being "exchanged"?
\end{quotation}

______________________________________________________________________________________________


Although it seems that we have successfully written the potential risk as a function of the observed data, we are in need of two more assumptions. The first is **correct model specification**. This assumption is required when we rely on models to estimate effects, but can be minimized or avoided by using semi- or non-parametric approaches. There are several ways in which this assumption can be violated, and these include the omission of relevant interaction terms, or adjusting for continuous covariates using linear terms only.

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 4:} Can you think of a relation between correct model misspecification and exchangeability?
\end{quotation}

______________________________________________________________________________________________

The second is **positivity**,^[Also known as the experimental treatment assignment assumption.] and requires exposed and unexposed individuals within all levels of the confounder [@Mortimer2005,@Westreich2010a]. There are two kinds of positivity violations (non-positivity): structural (or deterministic) and stochastic^[The word **stochastic** is derived from the greek word "to aim," as in "to aim for a target."] (or random). Structural non-positivity occurs when individuals with certain covariate values cannot be exposed. For example, in occupational epidemiology work-status (employed/unemployed in workplace under study) is a confounder, but individuals who leave the workplace can no longer be exposed to a work-based exposure. Alternatively, stochastic non-positivity arises when the sample size is not large enough to populate all confounder strata with observations. When faced with positivity violations, methods must be used that are not affected.^[Warning: one cannot simply "avoid" positivity. In an extreme setting, nonpositivity means that those who were exposed in the sample are very unlikely to be exposed (and vice versa). In such a situation, it may not make sense to estimate the average treatment effect, because there is a subset of the population who may never actually be exposed. In this case, g estimation, cTMLE, and the parametric g formula actually estimate parameters that differ slightly from the ATE.] These include g estimation of a structural nested model, collaborative targeted minimum loss-based estimation, and the parametric g formula.

\newpage
\noindent {\Large \bf \underline{The Parametric G Formula}}

In this section, we will illustrate implementation of the parametric g formula using four examples with simulated and empirical data. The first will be a very simple setting with one exposure, one confounder, and one outcome. This example will demonstrate model-based standardization, which is essentially what the parametric g formula does with complex longitudinal data. However, the data from the first example are neither complex nor longitudinal. 

The second example will be identical to the first, except the exposure will be measured twice (time-varying). It will also include a time-varying confounder measured once, but that creates a feedback loop between the first and second exposure measurement. This is the simplest complex longitudinal data scenario in which one can implement the g formula, and we will use it to emphasize core concepts. 

In the first two examples, we will establish a series of procedures to implement the g formula in a wide range of settings. Specifically, we will discuss problem setup, implementation, validation, and interpretation. The setup stage is about what you need to write down and organize to implement the parametric g formula. In the implementation stage, I will show you what models you need to fit based on the setup. After fitting these models, we need to evaluate quality (validation stage). Finally we must interpret in light of the assumptions we covered in the previous section.

The third example will be with actual data from the National Survey of Family Growth. We will answer questions about total, direct, and indirect effects (causal mediation).

Our final example will be the most complex. We will use data based on a randomized trial of daily low dose aspirin on pregnancy outcomes. We will deal with multiple time-points, and multiple competing outcomes. I will show you how to tailor implementation of the the g formula to a given study design.

The parametric g formula is the first of three "g" methods developed by James Robins beginning in the mid-1980s. The other g methods are: g estimation of a structural nested model, and inverse probability weighted marginal structural models.

Inverse probability weighted marginal structural models consist of two important parts: the marginal structural model, which is a model for potential outcomes (structural) averaged over the entire population (marginal). Inverse proabaility weights are a tool that enable estimation of the MSM parameters (e.g., weighted least squares or weighted maximum likelihood).

G estimation of a structural nested model also consist of two parts: the structural nested model, which is a model for a contrast of potential outcomes (structural) within levels of past time-varying and baseline covariates (nested). G estimation is an **estimator** that takes advantage of the independence between the potential outcomes and the observed expsoure (i.e., exchangeability) to solve for the parameters of a SNM.

Marginal structural and structural nested models target very different estimands. As we will see, the g formula is simply an equation that links potential outcomes to observed data (i.e., outcomes, exposures, confounders). It can be used to target the quantities defined in either marginal structural or structural nested models. As it turns out, if we are willing to model each of the terms in the (potentially lengthy) equation, can also use it to estimate the effects quantified by these models.

\noindent {\Large \bf Example 0: Model-Based Standardization}

Let's start with a simple simulated example, and presume it represents data to answer questions about the effect of treatment for HIV on CD4 count. The causal diagram representing this scenario is depicted in Figure 3. 

```{r, out.width = "200px",fig.cap="Causal diagram representing the relation between anti-retroviral treatment ($A$), HIV viral load just prior to treatment ($C$), and CD4 count measured at the end of follow-up ($Y$).",echo=F}
knitr::include_graphics("F3.pdf")
```
Table 1 presents data from this simulated observational cohort study ($A=1$ for treated, $A=0$ otherwise).

\begin{table}
\caption{Example data illustrating the number of subjects ($N$) within each possible combination of treatment ($A$) and HIV viral load ($C$). The outcome column ($Y$) corresponds to the mean of $Y$ within levels of $A$ and $C$.}
\begin{center}
\begin{tabular}{lllll}
&&&\\
\hline
$C$ & $A$ & $Y$ & $N$  \\
\hline \hline
0 & 0  & 94.3 & 344052 \\
0 & 1  & 119.2 & 154568 \\
1 & 0  & 130.6 & 154560 \\
1 & 1  & 155.7 & 346820 \\
\hline
\end{tabular}
\end{center}
\end{table}
The CD4 outcome in Table 1 is summarized (averaged) over the participants at each level of the treatments and covariate. Becuase the continuous outcome is summarized over each treatment $\times$ covariate level, we cannot estimate standard errors but will rather focus on estimating the parameter of interest.^[The bootstrap will be demonstrated in the Appendices.] We will analyze these data using model-based standardization, which is equivalent to the parametric g formula in a time-fixed exposure setting.

\noindent {\bf Setup}

We first start with the **setup**, where we define our estimand, order our variables causally, write down our models, and "tie" them together into the g formula. In this simple setting, our estimand of interest is the marginal average causal effect on the difference scale:
$$ E(Y^{a=1} - Y^{a=0})$$
This estimand tells us that we need to quantify two outcome averages: one that would be observed if everyone were exposed, and one if everyone were unexposed. 

Next, we examine our causal diagram to order our variables causally. The causal sequence of variables is: $C$ (first), $A$ (second), and $Y$ (third). To see why, note that in Figure 3 there are no variables that cause $C$, $A$ is caused by $C$, and $Y$ is caused by both $A$ and $C$. Becuase of this, $A$ cannot come before $C$ (an effect cannot precede its cause), nor can $Y$ come before $A$ or $C$. The causal ordering of our variables is therefore $C$, $A$, and $Y$.

We then write down models for each variable.^[Recall: The "$\expit$" function is the inverse of the logit: $\expit(a) = 1/[(1+\exp(-a)]$.] How do we know which models to specify? We regress each variable against everything that comes before it.
\begin{table}
\begin{tabular}{rl}
Variable & Model \\
$Y$ & $E(Y \mid A, C) = \alpha_0 + \alpha_1 A + \alpha_2 C$\\
$A$ & $P(A \mid C) = \expit(\beta_0 + \beta_1 C)$ \\
$C$ & $P(C ) = \expit(\gamma_0)$ \\
\end{tabular}
\end{table}

 However, we must ensure that we do not break the **cardinal rule: do not adjust for the future.**

Finally, we tie each of these models together to give us a pre-cursor to the g formula. To do this, we invoke the law of total probability, which states that the $P(A) = \sum_B P(A \mid B)P(B)$. This allows us to "average over" a conditional to obtain a marginal. In our case, the relevant conditional is the regression model for the outcome, and we have to average over the distributions of $A$ and $C$:
$$ E(Y) = \sum_A \sum_C E(Y \mid A, C)P(A\mid C) P(C)$$
To obtain the g formula from this expression, we replace all instances of $A$ with $A=a$ and remove $P(A \mid C)$
$$ E(Y^a) = \sum_C E(Y \mid A=a, C) P(C)$$
which holds under our identifiability assumptions.

\noindent {\bf Implementation and Validation}

We're now ready for **implementation**. Suppose we wanted to estimate the unconditional (i.e., marginal) mean outcome in the sample. There are two ways we can do this. The easy way would be to simply take the average in the sample:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
## CODE SET 2
# arrange into long data
C<-c(0,0,1,1);A<-c(0,1,0,1);Y<-c(94.3,119.2,130.6,155.7)
N<-c(344052,154568,154560,346820)
D<-NULL
for(i in 1:4){
  d<-data.frame(cbind(rep(C[i],N[i]),rep(A[i],N[i]),rep(Y[i],N[i])))
  D<-rbind(D,d)
}
names(D)<-c("C","A","Y")
# take the mean of Y
mean(D$Y)
## END CODE SET 2
```
But we could also compute the marginal mean using the law of total probability. To do this, we can estimate our models using the data, and then predict from each in sequence:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
## CODE SET 3
# fit models
mC<-glm(C~1,data=D,family=binomial("logit"))
mA<-glm(A~C,data=D,family=binomial("logit"))
mY<-glm(Y~A+C,data=D,family=gaussian("identity"))

## obtain predictions
# obtain C predictions
pC<-predict(mC,type="response")
# use predicted C to obtain predicted A
pA<-predict(mA,newdata=data.frame(C=pC),type="response")
# use predicted A and C to obtain predicted Y
pY<-predict(mY,newdata=data.frame(A=pA,C=pC),type="response")

# compute marginal mean of predicted Y
mean(pY)
## END CODE SET 3
```
The key is that $C$ is predicted, then $A$ is predicted using the $C$ predictions, and then $Y$ is predicted using the $A$ and $C$ predictions.

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Side Note:} To see why this works, suppose we're interested in the marginal (i.e., averaged over $C$) mean of $Y$ if $A=0$, and let's assume for illustrative purposes that $P(C=1) = 0.2$ (it's not in our example):
\begin{table}
\begin{tabular}{rl}
$E(Y \mid A=0)$ & = $ \sum_C E(Y \mid A=0,C)P(C)$ \\
                & = $E(Y \mid A=0,C=0)P(C=0) + E(Y \mid A=0,C=1)P(C=1)$ \\
                & = $\alpha_0 \times 0.8 + (\alpha_0+\alpha_2) \times 0.2$
\end{tabular}
\end{table}
\noindent Note that, in the second line of the above, $E(Y \mid A=0,C=0)$ and $E(Y \mid A=0,C=1)$ are just the averages of $Y$ among those with $A=0,C=0$ and $A=0,C=1$, respectively. We can therefore replace these with the parameters from our model. In a dataset of 100 people with $A=0$, $\sim 80$ would have $C=0$ and $\sim 20$ would have $C=1$. Among those 100, the true average outcome for those with $C=0$ would be $\alpha_0$, and the true average outcome for those with $C=1$ would be $\alpha_0+\alpha_2$. Therefore, the average of $Y$ among these 100 people with $A=0$ would be precisely the weighted combination of averages that we need: $\alpha_0 \times 0.8 + (\alpha_0+\alpha_2) \times 0.2$. This is why we can use our data and/or predictions to implement the law of total probability.
\end{quotation}

______________________________________________________________________________________________


Back to our original example, we have two versions of our outcome: the actual data (Y) and the predictions based on our models (pY). The mean of both these versions is the same: 125.0. This **validation** step tells us that our models are doing a decent job at recreating the averages that result from our actual data generating mechanisms.

Continuing with our **implementation**, we can also use this code to predict $Y$ if $A=1$ for everyone or if $A=0$ for everyone. We must just replace "A=pA" with "A=1" and "A=0" in the last line of code that yields the predictions we want. Replacing "A=pA" with "A=a" is tantamount to replacing all instances of $A$ in the above equations with $A=a$, and removing the $P(A\mid C)$ term:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
## CODE SET 4
# for A=1
pY_1<-predict(mY,newdata=data.frame(A=1,C=pC),type="response")
mY_1<-mean(pY_1)

#for A=0
pY_0<-predict(mY,newdata=data.frame(A=0,C=pC),type="response")
mY_0<-mean(pY_0)
## END CODE SET 4
```
\noindent The difference between these two means of interest is `r round(mY_1-mY_0,1)`, which we must **interpret**. 

\noindent {\bf Interpretation}

The basic question is whether we can interpret this difference as the causal effect of ART on CD4 count. To do this, we must refer back to the set of assumptions discussed in the section on identifiability. For counterfactual consistency, we must ask two key questions: 1) how many different ways are there to assign someone to ART?; and 2) will these different assignment mechanisms lead to different outcomes? Suppose, for instance, that 1/2 of the sample took ART with ibuprofen. Suppose further that ibuprofen reduces the efficacy of ART. We then have a situation where counterfactual consistency may be violated, becuase assigning someone to ART (without ibuprofen) will not lead to the same effect that was quantified in our study. If we assume that all of the different ways in which one can take ART will not really lead to different outcomes, we can assume counterfactual consistency.

For interference, we must ask whether giving someone ART will affect the CD4 count of another person. In this case, it seems reasonable to assume no such interference occurs. Exchangeability is something we often consider in epidemiology, and requires no uncontrolled confounding, information, or selection bias. 

Becuase of the small number of variables in this example, correct model specification is not likely to pose any problems. If, for example, an interaction between $A$ and $C$ in the model for $Y$ is required, our model would be mis-specified. With a small number of categorical variables, we can saturate all the models to estimate things nonparametrically. However, this is often not possible when there are many categorical confounders, or any continuous confounders.

Finally, for positivity, we must ask whether there are exposed and unexposed individuals in each confounder level. In our simple setting, it is easy to verify this with a $2\times 2$ table:
```{r}
table(D$A,D$C)
```
Becuase there are no empty cells in this table, we can assume positivity is met. Additionally, becuase we are willing to make all these identifiability assumptions, we infer that the causal effect of $A$ on $Y$ is `r round(mY_1-mY_0,1)`.

\noindent {\Large \bf Example 1: ART effect on CD4 Count (Simulated)}

In the previous example, we dealt with data that was neither longitudinal nor complex. We did not need to analyze these data using the g formula. In fact, a simple standard regression would have given us the same result. Here, we extend our previous example by adding an additional exposure, and converting our time-fixed confounder $C$ to a time-dependent confounder $Z$. Our research question again deals with the effect of treatment for HIV on CD4 count.^[This example was taken from @Naimi2016c] The causal diagram representing this scenario is depicted in Figure 4.
```{r, out.width = "200px",fig.cap="Causal diagram representing the relation between anti-retroviral treatment at time 0 ($A_0$), HIV viral load just prior to the second round of treatment ($Z_1$), anti-retroviral treatment status at time 1 ($A_1$), the CD4 count measured at the end of follow-up ($Y$), and an unmeasured common cause ($U$) of HIV viral load and CD4.",echo=F}
knitr::include_graphics("F4.pdf")
```

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 5:} Does the fact that $U$ is unmeasured in Figure 4 create problems for our analysis? Why or why not?
\end{quotation}

______________________________________________________________________________________________

Table 1 presents data from a hypothetical observational cohort study ($A=1$ for treated, $A=0$ otherwise). Treatment is measured at baseline ($A_0$) and once during follow up ($A_1$). The sole covariate is elevated HIV viral load ($Z=1$ for those with $>200$ copies/ml, $Z=0$ otherwise), which is constant by design at baseline ($Z_0=1$) and measured once during follow up just prior to the second treatment ($Z_1$). The outcome is CD4 count measured at the end of follow up in units of cells/mm$^3$. Again, the CD4 outcome in Table 1 is summarized (averaged) over the participants at each level of the treatments and covariate.

\begin{table}
\caption{Prospective study data illustrating the number of subjects ($N$) within each possible combination of treatment at time 0 ($A_0$), HIV viral load just prior to the second round of treatment ($Z_1$), and treatment status for the 2nd round of treatment ($A_1$). The outcome column ($Y$) corresponds to the mean of $Y$ within levels of $A_0$, $Z_1$, $A_1$. Note that HIV viral load at baseline is high ($Z_0 = 1$) for everyone by design.}\label{DATA}
\begin{tabular}{lllll}
\hline
$A_0$ & $Z_1$ & $A_1$ & $Y$ & $N$  \\
\hline \hline
0 & 0          &   0              &   87.29    & 209,271  \\
0 & 0          &   1              &   112.11  &  93,779 \\
0 & 1          &   0              &   119.65  &  60,654\\
0 & 1          &   1              &   144.84  &  136,293 \\
1 & 0          &   0              &   105.28  &  134,781  \\
1 & 0          &   1              &   130.18  &  60,789 \\
1 & 1          &   0              &   137.72  &  93,903 \\
1 & 1          &   1              &   162.83  &  210,527 \\
\hline
\end{tabular}
\end{table}

\noindent {\bf Setup}

The number of participants is provided in the rightmost column of Table 1. In this hypothetical study of one million participants we ignore random error (i.e., we will not focus on confidence interval estimation). Let's again start with the problem **setup**, where we define our estimand, order our variables causally, write down our models, and "tie" them together into the g formula. Here, we focus on the average causal effect of always taking treatment, $(a_0 = 1, a_1 = 1) \equiv \overline{a}_1=1$, compared to never taking treatment, $(a_0 = 0, a_1 = 0) \equiv \overline{a}_1=0$:
\begin{equation*}
	\psi = E(Y^{\overline{a}_1=1}) - E(Y^{\overline{a}_1=0}).
\end{equation*}
This average causal effect consists of the joint effect of $A_0$ and $A_1$ on $Y$ [@Daniel2013]. Here, $Y^{\overline{a}_1}$ represents a potential outcome value that would have been observed had the exposures been set to specific levels $a_0$ and $a_1$.

The causal order of our observed variables is: $A_0$, $Z_1$, $A_1$, and $Y$.^[Note that we ignore $U$ in this step becuase it is not measured.] For each of these variables, we can write down the following models:
\begin{table}
\begin{tabular}{rl}
Variable & Model \\
$Y$ & $E(Y \mid A_1, Z_1, A_0) = \alpha_0 + \alpha_1 A_1 + \alpha_2 Z_1 + \alpha_3 A_0$\\
$A_1$ & $P(A_1 \mid Z_1) = \expit(\beta_0 + \beta_1 Z_1)$ \\
$Z_1$ & $P(Z_1 \mid A_0) = \expit(\gamma_0 + \gamma_1 A_0)$ \\
$A_0$ & $P(A_0) = \expit(\theta_0)$ \\
\end{tabular}
\end{table}

Again, these models are obtained by regressing each variable against everything that comes before. Next, we tie each of these equations together to give us a precursor to the g formula. As in the previous example, we use the law of total probability to do this, which yields: 
\begin{equation*}
E(Y) = \sum_{A_1} \sum_{Z_1} \sum_{A_0} E(Y \mid A_1,Z_1,A_0)P(A_1 \mid Z_1) P(Z_1 \mid A_0 )P(A_0).
\end{equation*}
We get the g formula when we replace all instances of $A_0$ and $A_1$ with $a_0$ and $a_1$, respectively, and remove the models for $A_0$ and $A_1$:
\begin{equation*}
E(Y^{a_0,a_1}) = \sum_{Z_1} E(Y \mid A_1=a_1,Z_1,A_0=a_0)P(Z_1 \mid A_0=a_0 ).
\end{equation*}
\noindent which holds under our identifiability assumptions.

\noindent {\bf Implementation}

Let's now **implement** the g formula in our software programs. We will again start by estimating the unconditional (i.e., marginal) mean outcome in the sample, by first taking the sample average:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
## CODE SET 5
# arrange into wide data
a0<-c(0,0,0,0,1,1,1,1);z1<-c(0,0,1,1,0,0,1,1);a1<-c(0,1,0,1,0,1,0,1)
y<-c(87.29,112.11,119.65,144.84,105.28,130.18,137.72,162.83)
N<-c(209271,93779,60654,136293,134781,60789,93903,210527)
D<-NULL
for(i in 1:8){
  d<-data.frame(cbind(rep(a0[i],N[i]),rep(z1[i],N[i]),rep(a1[i],N[i]),rep(y[i],N[i])))
  D<-rbind(D,d)
}
names(D)<-c("a0","z1","a1","y")
# take the mean of Y
mean(D$y)
## END CODE SET 5
```
Next, we compute the marginal mean using the law of total probability by estimating our models using the data, and then predicting from each in sequence:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
## CODE SET 6
# fit models
mA0<-glm(a0~1,data=D,family=binomial("logit"))
mZ1<-glm(z1~a0,data=D,family=binomial("logit"))
mA1<-glm(a1~z1,data=D,family=binomial("logit"))
mY<-glm(y~a1+z1+a0,data=D,family=gaussian("identity"))

## obtain predictions
# obtain A0 predictions
pA0<-predict(mA0,type="response")
# use predicted A0 to obtain predicted Z1
pZ1<-predict(mZ1,newdata=data.frame(a0=pA0),type="response")
# use predicted Z1 to obtain predicted A1
pA1<-predict(mA1,newdata=data.frame(z1=pZ1),type="response")
# use predicted A0, Z1 and A1 to obtain predicted Y
pY<-predict(mY,newdata=data.frame(a0=pA0,z1=pZ1,a1=pA1),type="response")

# compute marginal mean of predicted Y
mean(pY)
## END CODE SET 6
```

\noindent {\bf Validation}

Once again, we have two versions of our outcome: the actual data (Y) and the predictions based on our models (pY). These latter predictions are obtained under a very specific scenario: by consistency and no interference, it is the outcome distribution that would be observed if the exposure distribution was what actually occurred in our data.\marginnote{$^{16}$ Note the evasive language ("some assurance", "suggests", etc). This is because unbiased causal effect estimation is still possible if the natural course and empirical results are very different. It is also possible that a parameter estimate is biased if the natural course and empirical results are identical. Thus, this validation step provides evidence that is neither necessary nor sufficient for valid estimation. However, becuase these scenarios are unlikely to occurr in practice, the evidence provided by this validation step is informative.} This scenario, called the **natural course**, is in contrast to what might have been observed if everyone were exposed/unexposed at both time-points. Estimating the natural course is an important **validation step** when using the parametric g formula. If the empirical results align closely with the natural course, this offers some assurance that our models are not grossly mis-specified. On the other hand, if our empirical and natural course results differ substantially, this suggests that something may be wrong.$^{16}$

In our example, the empirical and natural course means are again the same: `r round(mean(pY),1)`.

Continuing with our **implementation**, we can also use this code to predict $Y$ if $A=1$ for everyone or if $A=0$ for everyone:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
## CODE SET 7
# for A=1
pZ_1<-predict(mZ1,newdata=data.frame(a0=1),type="response")
pY_1<-predict(mY,newdata=data.frame(a0=1,z1=pZ_1,a1=1),type="response")
mY_1<-mean(pY_1)

#for A=0
pZ_0<-predict(mZ1,newdata=data.frame(a0=0),type="response")
pY_0<-predict(mY,newdata=data.frame(a0=0,z1=pZ_0,a1=0),type="response")
mY_0<-mean(pY_0)
## END CODE SET 7
```

\noindent {\bf Interpretation}

\noindent The difference between these two means is `r round(mY_1-mY_0,1)` cells/mL (a 25 cell/mL difference for each time-point, which corresponds to the true effect in our simulated scenario). If we make the same assumptions as in the previous example (counterfactual consistency, no interference, exchangeability, no model mis-specification, positivity), we can interpret this as our causal effect of interest.


______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Side Note:} The parametric g formula is subject to what is known as the "g null paradox," which arises when the true exposure effect is null. In this setting, it is possible that the parametric g formula will estimate a non-null effect. Not much is known about the g null paradox, but it is currently the topic of active research by several groups.
\end{quotation}

______________________________________________________________________________________________



Before moving on to our next examples, let's take another look at our second simulated example. According to the causal diagram in Figure 4, we should be able to obtain an unbiased estimate of the $A_0$ and $A_1$ effects using simple regression models. For example, if we adjust for $Z_1$, there is no open back-door path from $A_1$ to $Y$. If we run the code to do this, we find this is actually the case:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
# CODE SET 8
round(coef(glm(y~a1+z1,data=D,family=gaussian("identity"))),1)
# END CODE SET 8
```
Similarly, because there are no confounders of the relation between $A_0$ and $Y$, the causal diagram seems to suggest that simply regressing $Y$ against $A_0$ will give us an unbiased effect estimate (the true effect is 25.0 cells/mL):
```{r echo=T,fig.star=T,tidy=F,highlight=T}
# CODE SET 9
round(coef(glm(y~a0,data=D,family=gaussian("identity"))),1)
# END CODE SET 9
```
However, doing this overestimates the true effect by `r round(coef(glm(y~a0,data=D,family=gaussian("identity"))),1)[2]-25` cells/mL. Why? This is a consequence of feedback between $A_0$ and $A_1$. Becuase $A_0$ affects $A_1$ indirectly through $Z_1$, this regression model is estimating the overall effect of $A_0$ on $Y$. Thus, the estimate of `r round(coef(glm(y~a0,data=D,family=gaussian("identity"))),1)[2]` is not wrong \emph{per se}. It is simply quantifying the direct effect of $A_0$ on $Y$, **plus** the indirect effect of $A_0$ on $Y$ via $A_1$.

Note that while this estimate is not incorrect by itself, if we were intersted in estimating $E(Y^{\overline{a}_1=1}-Y^{\overline{a}_1=0})$, and we added the two estimates from these simple regression models to do this, we would be wrong because we'd be counting a portion of the $A_1$ effect twice.

\newpage
\noindent {\Large \bf Example 2: Mediation Analysis Using the Natural Survey of Family Growth}

In this second example, we will look at how to conduct mediation analyses using the parametric g formula with data from the publicly available Natural Survey of Family Growth [@NSFG2014]. For our purposes, we will ignore the complex survey sampling design. In this example, we will have the opportunity to get a close look at several controversial issues in causal inference. Notably, we will talk about the challenges in identifying, estimating, and interpreting natural direct and indirect effects [@Naimi2014c].^[There has recently been explosion in the number of estimands that can be defined to conduct mediation analyses. Among these include standardized direct effects [@Didelez2006], randomized interventional analogues to natural direct and indirect effects [@VanderWeele2014], "organic" direct and indirect effects [@Lok2016], and stochastic mediation contrasts [@Naimi2014b].] We will also look at the issues involved in estimating the effects of so-called "nonmanipulable" expsoures [@Hernan2008a].

Two types of effects are commonly used in mediation analysis. The first are controlled direct effects, which quantify the exposure effect under an intervention that sets the mediator to a specific value for all individuals in the population. Controlled indirect effects are notably difficult to conceptualize, and instead are defined as a contrast between the total and controlled direct effect in the absence of exposure-mediator interactions [@Kaufman2004]. The second type of direct effects are "natural" (which include "total" or "pure") effects. The natural direct effect quantifies exposure effect that would be observed holding the mediator fixed at the value it would have taken under some referent exposure value. Similarly, natural indirect effect quantifies the effect the exposure has through the mediator by changing the mediator from the value it would have taken under some referent exposure to the value it would have taken under some specific alternate exposure (all while holding the exposure fixed).

Here, we will estimate natural and controlled effects to evaluate the extent to which the racial disparity in preterm birth is "explained" by the manner in which a woman pays for the delivery of a pregnancy. As we will see, this question is itself problematic, but was chosen specifically to illustrate some rather subtle issues. On top of the problematic nature of the question itself,^[While the example here involves questions that might typically be asked in social epidemiology, these issues are also routinely encountered in other areas, including lifecourse epidemiology, research on the effects of growth, weight, obesity, or age.] we will have the opportunity to go over some of the challenges in identifying, interpreting, and estimating natural direct and indirect effects. Estimating controlled effects are also problematic in this setting, and we will see why. 

In spite of the challenges (which are not insignificant) inherent in using the NSFG data to answer this question, its didactic value is clear. It will give us plenty of opportunity to discuss the reasons for which natural effects are not identifiable,^[Note that Lin et al have developed a "parametric mediational g formula" algorithm for estimating what are known as randomzied interventional analogues to natural direct and indirect effects [@Lin2017]. This is a useful contribution that resolves the problems related to identifying and estimating natural effects.] and illustrate the challenges in estimating any "effects" of exposures such as race or payment method for delivery. 

\noindent {\bf Setup: Natural and Controlled Effects}

Let's begin with **setting up** the problem. In this setup section, we will again define our estimands of interest, causally order our variables, specify parametric models for each, and then link them together using the law of total probability. In our NSFG data, we will let $X$ denote race, $M$ denote the method of payment for delivery, and $Y$ denote preterm birth (1 if less than 37 weeks, 0 otherwise). We will also assume that the only confounders of the relation between race and the method of payment, or between race and preterm birth is maternal age.^[This is actually a realistic and defensible assumption, provided we are interested in quantifying disparities, and not estimating the "effects" of race [@Naimi2016c]] We will also let $C_{MY}$ denote confounders of the relation bewteen preterm birth and the method of delivery payment. In our analysis, these will include maternal age, prenatal care, the wantedness of a pregnancy, marital status, educational level, and the gestational age of a prior pregnancy.

The causal diagram that will be motivating our analysis will be as follows:
```{r, out.width = "200px",fig.cap="Causal diagram representing the relation between race ($X$), method of payment for delivery ($M$), and preterm birth ($Y$). In this diagram, $C_{MY}$ represent $M$-$Y$ confounders that are also associated with race.",echo=F}
knitr::include_graphics("FigureDag.pdf")
```

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 6:} Can you identify the structural similarities between Figures 4 and 5?
\end{quotation}

______________________________________________________________________________________________


Conceptually, the natural direct effect is the expected change in the outcome if we were to "freeze" the mediator value for each person at the level it would have taken had the person's exposure been some referent level (but when, in actuality, the person's exposure status changes). Similarly, the natural indirect effect is the expected change in the outcome when the mediator changes as though the exposure had (but when, in actuality, the exposure doesn't change). These natural effects are divided into two types: pure and total. 

The pure direct effect is the exposure effect if the mediator were held at its potential value under $X=0$:

$$ PDE = E \big (Y^{1,M^{0}}\big ) - E \big (Y^{0,M^{0}}\big ), $$

The total direct effect is identical to the pure direct effect, except that the mediator is held at its potential value under $X=1$:
$$ TDE = E \big (Y^{1,M^{1}}\big ) - E \big (Y^{0,M^{1}}\big ), $$

The controlled direct effect is also very similar, except that the mediator is held fixed at a given level uniformly in the population:
$$ CDE(m) = E \big (Y^{x,m}\big ) - E \big (Y^{x^*,m}\big ) $$

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Study Question 7:} Under what conditions will $TDE = PDE = CDE(m=0) = CDE(m=1)$?
\end{quotation}

______________________________________________________________________________________________

For all three estimands, the outcome $Y^{x,M^{x^*}}$ represents the potential outcome that would have been observed if $X$ were set to $x$ \emph{and} under the potential mediator value that would have been observed if $X$ were set to some other value $x^*$. Notice how the pure and total direct effects require a union of two logically incompatible states?: the outcome under exposure $x$ with the mediator set to what it would have been under $x^*$. Because no single individual can ever exist with exposure values $x$ and $x^*$, this composite counterfactual requires information that can only exist in two separate "worlds," and has thus been referred to as a "cross-world" counterfactual [@Richardson2013].

In a similar vein, the pure and total indirect effects are:
$$ PIE = E \big (Y^{0,M^{1}}\big ) - E \big (Y^{0,M^{0}}\big ), $$
and,
$$ TIE = E \big (Y^{1,M^{1}}\big ) - E \big (Y^{1,M^{0}}\big ). $$

These are the estimands that we will seek to estimate with the parametric g formula. Continuing our **setup**, we must next causally order our variables, including all of the $C_{MY}$.

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Side Note:} Thus far, we've been causally ordering {\bf all} of the variables in our causal diagrams. In actuality, we only have to order the variables that come after the exposure. We do not have to order the baseline variables, or the variables at the first time-point that are not affected by the exposure. Becuase there are no baseline variables in our mediation example (no confounders of the race-preterm birth relation), we will also order all our variables here too. But in the next example, we will see how to deal with pre-exposure variables.
\end{quotation}

______________________________________________________________________________________________

In Table 3, the race variables as coded as 1="non-Hispanic Black" and 0="non-Hispanic white". The mediator was payment for delivery, and was coded as 1="Medicaid/government assistance", and 0="insurance only, own income and insurance, or other combinations of payment method." Thus, for example, if we set $M=0$, then the CDE is interpreted as the effect of race that would be observed if everyone paid for delivery using insurance only, own income and insurance, or other combinations of payment method.^[Warning: as we will see in the interpretation section, we will not be able to interpret any of these results as "effects".]

\begin{table}[h]
\small\sf\centering
\caption{Assumed causal ordering of variables in the National Survey of Family Growth, 2006-2010 and 2011-2013 waves.\label{order}}
\begin{tabular}{lll}
\toprule
Order & Notation & Variable \\
\midrule
9 & $Y$ & Preterm birth \\
8 & $M$ & Payment for delivery \\
7 & $C_{(7)MY}$ & Prenatal care \\
6 & $C_{(6)MY}$ & Wantedness of the pregnancy \\
5 & $C_{(5)MY}$ & Gestational age at birth of prior pregnancy \\
4 & $C_{(4)MY}$ & Marital status at conception \\
3 & $C_{(3)MY}$ & Maternal education at conception \\
2 & $X$ & Race \\
1 & $C_{XY}$ & Maternal age \\
\bottomrule
\end{tabular}\\[10pt]
\end{table}

Now that we have chosen a causal order, we to specify models for each variable in Table 3. Instead of writing each model out as before, we will simply note that each variable in Table 3 is binary, prompting use of logistic regression. Furthermore, each variable will be regressed against everything that comes before it in Table 3.^[If this is not clear, the code implementing this below should help.] Finally, we have to tie all these models together using the law of total probability to obtain the g formula for our mediation questions. Doing so, we get:
\begin{equation*}
\begin{split}
E(Y^{x,M^{x^*}}) = & \sum_{C_{MY}} E(Y \mid X=x,M^{x^*}, C_{MY}, C_{XY} ) P(M \mid X = x^*,C_{MY}) \\ 
& \hskip .5cm \prod_{j=7:3} P(C_{(j)MY} \mid X=x,C_{(j-1)MY}, \ldots, C_{(3)MY}) P(C_{XY}), 
\end{split}
\end{equation*}
for the natural effects, and 
\begin{equation*}
\begin{split}
E(Y^{x,m}) = & \sum_{C_{MY}} E(Y \mid X=x,M=m, C_{MY}, C_{XY}) \\ 
& \hskip .5cm \prod_{j=7:3} P(C_{(j)MY} \mid X=x,C_{(j-1)MY}, \ldots, C_{(3)MY}) P(C_{XY}), 
\end{split}
\end{equation*}
for the controlled effect. 

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Side Note:} There has been some controversy over natural effects. There are several reasons for this controversy. One of them is the fact that defining natural effects requires outcomes under two logically incompatible exposure states. The other is more complicated, but arises when mediator outcome confounders are affected by the exposure. In this situation, mediator-outcome confounders affected by the exposure are known as "recanting witnesses." On the one hand, they signal to the mediator that they are in one state (unexposed) while simultaneously signalling to the outcome that they are in another state (exposed). With the exception of Naimi et al (2014), this issue has not been discussed in the health sciences literature.
\end{quotation}

______________________________________________________________________________________________

\noindent {\bf Implementation}

Now that we have setup the problem, lets begin with implementation. We first import and explore the NSFG data:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
setwd("~/Dropbox/Documents/Courses/EPI2187/2017/")
nsfg<-read_sas("n2.sas7bdat")
head(nsfg,3);tail(nsfg,3)
# sample size
nrow(nsfg)

# verify no missing
missFunc<-function(x){sum(is.na(x))}
sum(apply(nsfg,2,missFunc))

# tabular analyses
table(nsfg$pay_d)
table(nsfg$HISPRACE)
table(nsfg$ptb)
```

We should also look at the crude associations between the exposure, mediator, and outcome: 
```{r echo=T,fig.star=T,tidy=F,highlight=T}
# risk differences between exposure, mediator, and outcome
## preterm birth and race
coef(lm(ptb~HISPRACE,data=nsfg))[2]*100
## preterm birth and delivery payment 
coef(lm(ptb~pay_d,data=nsfg))[2]*100
## delivery payment and race
coef(lm(pay_d~HISPRACE,data=nsfg))[2]*100
```



```{r fig.height = 4, fig.width = 4, fig.align = "center",echo=T,fig.star=T,tidy=F,highlight=T,message=F}
# look at propensity score overlap for mediator (pay_d)
mod<-glm(pay_d~HISPRACE+pnc_d20+educ_d+marit_d
         +want_d+mage_c1+mage_c2+mage_c3+wksg_d,data=nsfg,family=binomial("logit"))
nsfg$pM<-predict(mod,type="response")*nsfg$pay_d+
  (1-predict(mod,type="response"))*(1-nsfg$pay_d)

ggplot(nsfg,aes(pM,color=factor(HISPRACE))) + 
  theme_light() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  labs(x = "Propensity Score",y = "Density") + 
  scale_colour_brewer(palette="Set1") +
  geom_density() + theme(
  legend.position = c(.5, .95),
  legend.justification = c("right", "top"),
  legend.box.just = "right",
  legend.margin = margin(6, 6, 6, 6)
)

```

Now that we've explored the data, let's fit models for each equation in the g formula.
```{r echo=T,fig.star=T,tidy=F,highlight=T}
# logistic models for joint distribution of observed data
## preterm birth 
m9<-glm(ptb~pay_d+pnc_d20+want_d+wksg_d+
          marit_d+educ_d+HISPRACE+pay_d*HISPRACE+
          mage_c1+mage_c2+mage_c3,data=nsfg,family=binomial("logit"))
## mediator
m8<-glm(pay_d~pnc_d20+want_d+wksg_d+
          marit_d+educ_d+HISPRACE+
          mage_c1+mage_c2+mage_c3,data=nsfg,family=binomial("logit"))
## pnc
m7<-glm(pnc_d20~want_d+wksg_d+
          marit_d+educ_d+HISPRACE+
          mage_c1+mage_c2+mage_c3,data=nsfg,family=binomial("logit"))
## wantedness
m6<-glm(want_d~wksg_d+
          marit_d+educ_d+HISPRACE+
          mage_c1+mage_c2+mage_c3,data=nsfg,family=binomial("logit"))
## prior gestational age at birth
m5<-glm(wksg_d~marit_d+educ_d+HISPRACE+
          mage_c1+mage_c2+mage_c3,data=nsfg,family=binomial("logit"))
## marital status
m4<-glm(marit_d~educ_d+HISPRACE+
          mage_c1+mage_c2+mage_c3,data=nsfg,family=binomial("logit"))
## educational status
m3<-glm(educ_d~HISPRACE+mage_c1+mage_c2+mage_c3,data=nsfg,family=binomial("logit"))
```
Next we select a Monte Carlo sample of 50,000, and keep only the baseline data (maternal age and race). We then predict the follow up under the exposure and mediator scenarios we need to quantify our estimands:
```{r echo=T,fig.star=T,tidy=F,highlight=T}
index<-sample(1:nrow(nsfg),5e4,replace=T)
mc<-nsfg[index,c("HISPRACE","mage_c1","mage_c2","mage_c3")]
head(mc);nrow(mc)

pgfm<-function(exposure,mediator){
  if(!is.null(exposure)){
    mc$HISPRACE<-exposure
  }
  e<-as.numeric(predict(m3,newdata=mc,type="response")>
                  runif(nrow(mc)));ND<-data.frame(mc,educ_d=e)
  m<-as.numeric(predict(m4,newdata=ND,type="response")>
                  runif(nrow(mc)));ND<-data.frame(ND,marit_d=m)
  w<-as.numeric(predict(m5,newdata=ND,type="response")>
                  runif(nrow(mc)));ND<-data.frame(ND,wksg_d=w)
  wnt<-as.numeric(predict(m6,newdata=ND,type="response")>
                  runif(nrow(mc)));ND<-data.frame(ND,want_d=wnt)
  pnc<-as.numeric(predict(m7,newdata=ND,type="response")>
                  runif(nrow(mc)));ND<-data.frame(ND,pnc_d20=pnc)
  if(is.null(mediator)){
      pay<-as.numeric(predict(m8,newdata=ND,type="response")>
                  runif(nrow(mc)));ND<-data.frame(ND,pay_d=pay)
  } else if(mediator=="n1"){
      ND<-data.frame(ND,HISPRACE=1)
      pay<-as.numeric(predict(m8,newdata=ND,type="response")>
                  runif(nrow(mc)));ND<-data.frame(ND,pay_d=pay)
  } else if(mediator=="n0"){
      ND<-data.frame(ND,HISPRACE=0)
      pay<-as.numeric(predict(m8,newdata=ND,type="response")>
                  runif(nrow(mc)));ND<-data.frame(ND,pay_d=pay)
  } else{
      pay<-mediator;ND<-data.frame(ND,pay_d=pay)
  }
  ptb<-as.numeric(predict(m9,newdata=ND,type="response")>
                  runif(nrow(mc)))
  return(ptb)
}

Yn<-pgfm(NULL,NULL) # natural course
Y1<-pgfm(1,NULL) # NH Black
Y0<-pgfm(0,NULL) # NH White
Y1mn0<-pgfm(1,"n0") # NH Black, NH White method of payment
Y0mn0<-pgfm(0,"n0") # NH White, NH White method of payment
Y1mn1<-pgfm(1,"n1") # NH Black, NH Black method of payment
Y0mn1<-pgfm(0,"n1") # NH White, NH Black method of payment
Y1m0<-pgfm(1,0) # NH Black, Insurance, Own Income, or Other method of payment
Y0m0<-pgfm(0,0) # NH White, Insurance, Own Income, or Other method of payment

# disparity
(mean(Y1)-mean(Y0))*100
# PDE
(mean(Y1mn0)-mean(Y0mn0))*100
# PIE
(mean(Y0mn1)-mean(Y0mn0))*100
# TDE
(mean(Y1mn1)-mean(Y0mn1))*100
# TIE
(mean(Y1mn1)-mean(Y1mn0))*100
# CDE
(mean(Y1m0)-mean(Y0m0))*100
```

\noindent {\bf Validation and Interpretation}

After quantifying these associations, we must now validate, and interpret them in light of the assumptions listed above. First we compare the natural course preterm birth generated from our g formula algorithm to the observed preterm birth outcomes in the NSFG. We can do this using several measures, but to keep things simple we will look at means. The natural course mean for preterm birth was `r round(mean(Yn),3)` while the preterm birth mean in the empirical data was `r round(mean(nsfg$ptb),3)`.

Let's start with interpreting the controlled direct effect estimate of `r round((mean(Y1m0)-mean(Y0m0))*100,3)`. From the point of view of the estimand alone, the CDE is interpreted as (for example) the exposure effect that would be observed if everyone's exposure was set to 1 and the mediator was set to 0, versus if everyone's exposure was set to 1 and the mediator was set to 0:
$$ CDE(0) = E \big (Y^{1,0}\big ) - E \big (Y^{0,0}\big ) $$
Our exposure was "race," which was measured as a combination of a response to a questionnaire that asked "what is your race?" and "are you Hispanic or Latina, or of Spanish origin?" To interpret the association we quantified as a controlled direct effect, we must assume counterfactual consistency, which allows us to state that the observed outcome among those who classified themselves as non-Hispanic black is, in fact, what we would have observed had we (somehow) set them to be non-Hispanic black. Unfortunately, there is no conceivable intervention that we could conjure up to set individuals to be, e.g., "non-Hispanic black." For this reason, self or other reported measures of race cannot be construed as counterfactually causal.

______________________________________________________________________________________________
\begin{quotation}
\noindent \textsc{Side Note:} This has been a somewhat controversial issue. But the controversy stems (in large part) from a misunderstanding. "Race," measured as the response to questions about whether one considers oneself non-Hispanic Black, White, Hispanic, etc, cannot be causal. But these measures do not quantify the fundamental issues that underlie health disparities. Race relations, on the other hand, can be affected by social policy and a host of other interventions. Such interventions can easily be incorporated into the causal modelling framework without issue. Numerous examples exits, and include the Civil Rights Act of the mid 1960s, the desegregation of hospitals, and the repeal of unjust laws, which are all (policy) interventions, far removed from the simplistic classification schemes commonly used to represent "race."
\end{quotation}

______________________________________________________________________________________________

Counterfactual consistency is a fundamental assumption in that most other assumptions depend on it. Consider, for example, the arrow from $C_{XY}$ to $X$ in Figure 5. This arrow implies that there is some mechanism by which we can affect race. Translated into the counterfactual world, this means that we would somehow be able to intervene so as to set $X$ ("race") to some specified value. But we have just argued that there is no such intervention. This raises the question about what it means for self reported race to be confounded. A confounder is a variable that affects both the exposure and the outcome. But if the expsoure can't be affected, how can it be confounded?

Points for further discussion:
\begin{itemize}
  \item Natural Effects: Cross World Counterfactuals and Recanting Witness
  \item Causal inference in social epidemiology 
  \item Other
\end{itemize}

\newpage

# References